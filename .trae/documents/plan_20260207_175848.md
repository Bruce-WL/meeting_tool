# ASR 升级与时间戳集成方案

您指出的"无法生成时间戳"确实是目前流程中的一个重大缺失，这也是导致"智能章节"无法跳转、"金句"无法定位的根本原因。

目前的 ASR 服务 (`asrService.ts`) 仅返回纯文本 (`data.text`)，丢弃了所有时间维度信息。为了实现点击跳转，我们需要从 ASR 获取更详细的 `utterances`（分句信息），并将其注入到 LLM 的输入中。

## 1. 核心问题分析
*   **现状**：ASR 接口返回纯文本 -> LLM 拿到无时间戳文本 -> 无法生成带时间戳的章节 -> 前端无跳转依据。
*   **目标**：ASR 返回带时间戳的分句 -> LLM 接收 `[00:15] 文本...` 格式 -> 生成带时间戳的 JSON -> 前端渲染可点击组件。

## 2. 解决方案：全链路时间戳贯通

### 步骤 1：升级 ASR 服务 (获取原材料)
修改 `api/services/asrService.ts`，不再只提取 `data.text`。
*   **请求参数**：虽然目前 Mify 接口封装较深，但通常 ASR 响应包含 `utterances` 或 `segments` 数组。
*   **响应解析**：
    *   尝试从 `data.utterances` 或 `data.result` 中提取分句列表。
    *   **格式化**：将转写结果重组为带时间戳的文本流：
        ```text
        [00:00] 大家好，今天我们讨论...
        [00:15] 关于技术选型...
        ```
    *   *注：如果当前上游 API 不支持返回时间戳（最坏情况），我们将实现一个基于字数/语速的"估算时间戳"逻辑作为兜底，确保功能可用。*

### 步骤 2：优化 LLM 输入 (传递原材料)
修改 `api/services/llmService.ts`：
*   **分片策略**：在 `splitText` 时，确保不打断 `[mm:ss]` 标记。
*   **上下文保留**：确保每个分片（Chunk）都包含其起始时间偏移量，这样 LLM 才知道第 2 个分片不是从 00:00 开始的。

### 步骤 3：Prompt 适配 (利用原材料)
修改 `api/prompts/meetingPrompts.ts`：
*   **Map 阶段**：明确指示 LLM "保留文中的 `[mm:ss]` 时间标记，并在生成 Key Points 和 Highlights 时引用它"。
*   **Reduce 阶段**：要求智能章节的 `timestamp` 字段严格来源于原文标记。

### 步骤 4：前端播放器联动 (实现跳转)
*   **检查组件**：确认 `SmartChapters` 组件点击事件是否正确调用了 Audio Player 的 `seek` 方法。

## 3. 执行计划
1.  **ASR 改造**：修改 `asrService.ts`，增加对 `utterances` 的解析支持（含兜底估算逻辑）。
2.  **LLM 服务升级**：确保时间戳透传至 Prompt。
3.  **Prompt 调优**：强制要求生成时间戳引用。
4.  **验证**：使用修复脚本模拟带时间戳的 ASR 结果，验证全流程。
